name: Burndown (Project v2)

on:
  workflow_dispatch:
    inputs:
      sprint_name:
        description: "Sprint name used in filenames (e.g., sprint4)"
        required: true
        default: "sprint4"
      milestone_name:
        description: "Milestone title to filter issues/PRs (defaults to sprint_name)"
        required: false
        default: ""

  # GitHub cron is UTC.
  # 03:00 UTC daily ≈ 10:00 PM America/Montreal (EST, UTC-5)
  schedule:
    - cron: "0 3 * * *"

permissions:
  contents: write

jobs:
  burndown:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.BURNDOWN_TOKEN }}
      OWNER: Georges999
      PROJECT_NUMBER: "2"

      POINTS_FIELD_NAME: "Story Point (1 --> 5)"
      STATUS_FIELD_NAME: "Status"
      DONE_STATUS_NAME: "Done"

    steps:
      - uses: actions/checkout@v4

      - name: Generate burndown snapshot + chart
        id: generate
        env:
          SPRINT_NAME: ${{ inputs.sprint_name || 'sprint4' }}
          MILESTONE_FILTER: ${{ inputs.milestone_name || inputs.sprint_name || 'sprint4' }}
        run: |
          set -e

          # Sanity check: token present (won't print it)
          if [ -z "${GH_TOKEN:-}" ]; then
            echo "ERROR: GH_TOKEN is empty. Set secrets.BURNDOWN_TOKEN to a valid PAT."
            exit 1
          fi

          echo "Scheduled run (${GITHUB_EVENT_NAME}) — running daily (no biweekly skip)."

          mkdir -p data

          CSV_FILE="data/burndown_${SPRINT_NAME}.csv"
          PNG_FILE="data/burndown_${SPRINT_NAME}.png"

          # -----------------------------
          # 1) Get Project v2 ID (user-owned project)
          # -----------------------------
          echo "Querying ProjectV2 id for owner=$OWNER project=$PROJECT_NUMBER"

          RAW=$(curl -sS \
            -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\":\"query{ user(login:\\\"$OWNER\\\"){ projectV2(number:$PROJECT_NUMBER){ id }}}\"}" \
            https://api.github.com/graphql)

          echo "Raw response (first 500 chars):"
          echo "$RAW" | head -c 500
          echo ""

          PROJECT_ID=$(RAW_JSON="$RAW" python3 - <<'PY'
          import os, json
          txt = os.environ.get("RAW_JSON", "").strip()
          if not txt:
              raise SystemExit("ERROR: Empty response from GraphQL (Project ID query).")
          j = json.loads(txt)
          if "errors" in j:
              raise SystemExit("ERRORS from GraphQL (Project ID query): " + json.dumps(j["errors"], indent=2))
          u = j.get("data", {}).get("user")
          if not u:
              raise SystemExit("ERROR: data.user is null (wrong OWNER or project is org-owned).")
          p = u.get("projectV2")
          if not p:
              raise SystemExit("ERROR: projectV2 is null (wrong PROJECT_NUMBER or no access).")
          print(p["id"])
          PY
          )

          echo "PROJECT_ID: $PROJECT_ID"
          export PROJECT_ID="$PROJECT_ID"

          # -----------------------------
          # 2) Fetch ALL items + field values + milestone (PAGINATED)
          # -----------------------------
          RESP=$(python3 - <<'PY'
          import os, json, subprocess, sys

          token = os.environ["GH_TOKEN"]
          project_id = os.environ["PROJECT_ID"]

          query = """
          query($id: ID!, $after: String) {
            node(id: $id) {
              ... on ProjectV2 {
                items(first: 100, after: $after) {
                  pageInfo { hasNextPage endCursor }
                  nodes {
                    content {
                      ... on Issue { milestone { title } }
                      ... on PullRequest { milestone { title } }
                    }
                    fieldValues(first: 50) {
                      nodes {
                        ... on ProjectV2ItemFieldNumberValue {
                          number
                          field { ... on ProjectV2FieldCommon { name } }
                        }
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                          field { ... on ProjectV2FieldCommon { name } }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
          """

          def gql(after):
            payload = {"query": query, "variables": {"id": project_id, "after": after}}
            cmd = [
              "curl","-sS",
              "-H", f"Authorization: bearer {token}",
              "-H", "Content-Type: application/json",
              "-d", json.dumps(payload),
              "https://api.github.com/graphql"
            ]
            p = subprocess.run(cmd, capture_output=True, text=True)
            out = (p.stdout or "").strip()
            if not out:
              err = (p.stderr or "").strip()
              print("ERROR: Empty response from GraphQL (items query).", file=sys.stderr)
              if err:
                print("curl stderr:", err, file=sys.stderr)
              sys.exit(1)
            j = json.loads(out)
            if "errors" in j:
              print("ERRORS from GraphQL (items query): " + json.dumps(j["errors"], indent=2), file=sys.stderr)
              sys.exit(1)
            return j

          all_nodes = []
          after = None

          while True:
            j = gql(after)
            node = (j.get("data") or {}).get("node") or {}
            items = (node.get("items") or {})
            nodes = items.get("nodes") or []
            all_nodes.extend(nodes)

            page = items.get("pageInfo") or {}
            if not page.get("hasNextPage"):
              break
            after = page.get("endCursor")
            if not after:
              break

          print(json.dumps({
            "data": {
              "node": {
                "items": {
                  "nodes": all_nodes
                }
              }
            }
          }))
          PY
          )

          echo "Items query response (first 500 chars):"
          echo "$RESP" | head -c 500
          echo ""

          # -----------------------------
          # 3) Sum remaining points where Status != Done AND milestone == sprint
          # -----------------------------
          REMAINING=$(RESP_JSON="$RESP" python3 - <<'PY'
          import os, json

          txt = os.environ.get("RESP_JSON", "").strip()
          j = json.loads(txt)

          node = j.get("data", {}).get("node", {}) or {}
          items = (node.get("items", {}) or {}).get("nodes", []) or []

          POINTS_FIELD = os.environ["POINTS_FIELD_NAME"]
          STATUS_FIELD = os.environ["STATUS_FIELD_NAME"]
          DONE = os.environ["DONE_STATUS_NAME"]
          MILESTONE_FILTER = os.environ["MILESTONE_FILTER"]

          remaining = 0.0
          for it in items:
              points = 0.0
              status = None

              content = it.get("content") or {}
              ms = (content.get("milestone") or {}) if content else {}
              milestone_title = ms.get("title")

              in_sprint = (milestone_title == MILESTONE_FILTER)

              for fv in ((it.get("fieldValues", {}) or {}).get("nodes", []) or []):
                  field = ((fv.get("field") or {}).get("name"))
                  if field == POINTS_FIELD and fv.get("number") is not None:
                      points = float(fv["number"])
                  if field == STATUS_FIELD and fv.get("name") is not None:
                      status = fv["name"]

              if in_sprint and status != DONE:
                  remaining += points

          if abs(remaining - round(remaining)) < 1e-9:
              print(int(round(remaining)))
          else:
              print(remaining)
          PY
          )

          echo "Remaining points for ${SPRINT_NAME} (milestone=${MILESTONE_FILTER}): $REMAINING"

          TODAY=$(date -u +%F)

          # -----------------------------
          # 4) Append/update CSV (one row per date)
          # -----------------------------
          if [ ! -f "$CSV_FILE" ]; then
            echo "date,remaining_points" > "$CSV_FILE"
          fi
          grep -v "^$TODAY," "$CSV_FILE" > data/tmp.csv || true
          mv data/tmp.csv "$CSV_FILE"
          echo "$TODAY,$REMAINING" >> "$CSV_FILE"

          # -----------------------------
          # 5) Generate chart PNG using QuickChart (saved into data/)
          # -----------------------------
          python3 - <<'PY'
          import os, csv, json, urllib.parse
          from pathlib import Path

          sprint = os.environ["SPRINT_NAME"]
          csv_path = f"data/burndown_{sprint}.csv"
          rows = list(csv.DictReader(open(csv_path)))

          labels = [r["date"] for r in rows]
          data = [float(r["remaining_points"]) for r in rows]

          config = {
            "type": "line",
            "data": {"labels": labels, "datasets": [{"label": "Remaining Story Points", "data": data}]},
            "options": {"scales": {"y": {"beginAtZero": True}}}
          }

          url = "https://quickchart.io/chart?c=" + urllib.parse.quote(json.dumps(config))
          Path("data/burndown_url.txt").write_text(url)
          PY

          curl -fLsS "$(cat data/burndown_url.txt)" -o "$PNG_FILE"

          if [ -f "$CSV_FILE" ] || [ -f "$PNG_FILE" ]; then
            echo "should_commit=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_commit=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit updated burndown files
        if: steps.generate.outputs.should_commit == 'true'
        env:
          SPRINT_NAME: ${{ inputs.sprint_name || 'sprint4' }}
        run: |
          set -e

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          CSV="data/burndown_${SPRINT_NAME}.csv"
          PNG="data/burndown_${SPRINT_NAME}.png"

          echo "Working directory: $(pwd)"
          echo "Checking expected artifacts:"
          ls -la data || true

          TO_ADD=()
          [ -f "$CSV" ] && TO_ADD+=("$CSV") || echo "Missing: $CSV"
          [ -f "$PNG" ] && TO_ADD+=("$PNG") || echo "Missing: $PNG"

          if [ ${#TO_ADD[@]} -eq 0 ]; then
            echo "No burndown artifacts found to commit. Skipping."
            exit 0
          fi

          git add "${TO_ADD[@]}"

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update burndown (${SPRINT_NAME})"
          git push