name:  Tests and scans CI

on:
  push:
    paths:
      - 'frontend/**'
      - '.github/workflows/Ci-pipeline.yml'
  pull_request:
    paths:
      - 'frontend/**'
      - '.github/workflows/Ci-pipeline.yml'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm install --legacy-peer-deps

      - name: Run tests with coverage
        working-directory: frontend
        run: npm run test:coverage

      - name: Upload coverage for SonarCloud
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/coverage/lcov.info

      - name: Coverage report (pipeline)
        if: success()
        run: |
          LCOV=frontend/coverage/lcov.info
          echo "## Frontend coverage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ ! -f "$LCOV" ]; then
            echo "No \`lcov.info\` found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          total_lf=0
          total_lh=0
          file_lf=0
          file_lh=0
          current_file=""
          echo "| File | Lines | Covered | % |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------:|--------:|--:|" >> $GITHUB_STEP_SUMMARY
          while IFS= read -r line || [ -n "$line" ]; do
            case "$line" in
              SF:*) current_file="${line#SF:}"; file_lf=0; file_lh=0 ;;
              LF:*) file_lf="${line#LF:}"; total_lf=$((total_lf + file_lf)) ;;
              LH:*)
                file_lh="${line#LH:}"
                total_lh=$((total_lh + file_lh))
                name=$(basename "$current_file")
                if [ "$file_lf" -gt 0 ]; then
                  pct=$((file_lh * 100 / file_lf))
                else
                  pct=100
                fi
                echo "| \`$name\` | $file_lf | $file_lh | ${pct}% |" >> $GITHUB_STEP_SUMMARY
                ;;
            esac
          done < "$LCOV"
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "$total_lf" -gt 0 ]; then
            pct=$((total_lh * 100 / total_lf))
            echo "**Total: $total_lh / $total_lf lines ($pct%)**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Full report is also sent to SonarCloud (see **SonarCloud report** job)." >> $GITHUB_STEP_SUMMARY

  sonarcloud:
    name: SonarCloud report
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      pull-requests: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download coverage
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage

      - name: Restore and fix coverage paths for SonarCloud
        run: |
          # Artifact may be at root (lcov.info) or preserved path (frontend/coverage/lcov.info)
          if [ -f frontend/coverage/lcov.info ]; then
            LCOV_FILE=frontend/coverage/lcov.info
          else
            mkdir -p frontend/coverage
            mv lcov.info frontend/coverage/lcov.info
            LCOV_FILE=frontend/coverage/lcov.info
          fi
          # Paths in lcov must match sonar.sources (relative to repo root).
          # Jest runs from frontend/ so it emits paths like SF:src/... and SF:App.js
          sed -i "s|SF:${GITHUB_WORKSPACE}/frontend/|SF:frontend/|g" "$LCOV_FILE"
          sed -i 's|SF:src/|SF:frontend/src/|g' "$LCOV_FILE"
          sed -i 's|SF:App\.js|SF:frontend/App.js|g' "$LCOV_FILE"
          sed -i 's|SF:app\.config\.js|SF:frontend/app.config.js|g' "$LCOV_FILE"
          echo "Sample paths in lcov (first 5 SF: lines):"
          grep '^SF:' "$LCOV_FILE" | head -5

      - name: SonarCloud scan
        run: |
          docker run --rm \
            -v "$PWD:/usr/src" -w /usr/src \
            -e SONAR_TOKEN="$SONAR_TOKEN" \
            sonarsource/sonar-scanner-cli:latest \
            -Dproject.settings=frontend/sonar-project.properties \
            -Dsonar.branch.name="$BRANCH_NAME"
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}

      - name: Report link
        run: |
          echo "## SonarCloud report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**[View report](https://sonarcloud.io/dashboard?id=campus-guide-frontend)**" >> $GITHUB_STEP_SUMMARY